<!-- Implements the Splitter aggregator pattern. -->
<states>
<flow id='PROCESS_FLOW' default="true">
	<if id='isDormant' condition="dormant" then="isDormant" else="isNotDormant" initialState="true">
		<on eventId="isDormant" newStateId="DORMANT"/>
		<on eventId="isNotDormant" newStateId="isThisLeafNode"/>
	</if>

	<if id='isThisLeafNode' condition="leaf" then="isLeaf" else="isNotLeaf">
		<on eventId="isLeaf" newStateId="EXECUTING"/>
		<on eventId="isNotLeaf" newStateId="SPLIT_PENDING"/>
	</if>
	<manual-state id='DORMANT'>
		<on eventId="activate" newStateId="isThisLeafNode"/>
	</manual-state>
	<manual-state id='SPLIT_PENDING'>
			<on eventId="splitUpdate" newStateId="SUB_PROCESSES_PENDING"/>
			<on eventId="splitDone" newStateId='SUB_PROCESSES_PENDING'/>
			<on eventId="splitDoneWithErrors" newStateId='PROCESSED_WITH_ERRORS'/>
	</manual-state>

	<manual-state id="EXECUTING">
		<on eventId="statusUpdate"/>
		<on eventId="doneSuccessfully" newStateId="PROCESSED"/>
		<on eventId="doneWithErrors" newStateId="PROCESSED_WITH_ERRORS"/>
	</manual-state>

	<manual-state id='SUB_PROCESSES_PENDING'>
			<on eventId="splitUpdate"/>
			<on eventId="splitDone" newStateId='areAllSubProcessesDone'/>
			<on eventId="subProcessDoneSuccessfully" newStateId='areAllSubProcessesDone'/>
			<on eventId="subProcessDoneWithErrors" newStateId='areAllSubProcessesDone'/>
	</manual-state>

	<if id='areAllSubProcessesDone' condition="(numSubProcesses == numCompletedSubProcesses)
                        &amp;&amp; splitCompleted " then="yes" else="no">
			<on eventId="yes" newStateId='AGGREGATION_PENDING'/>
			<on eventId="no" newStateId="SUB_PROCESSES_PENDING"/>
	</if>

	<manual-state id="AGGREGATION_PENDING">
		<on eventId="aggregationDone" newStateId="areThereErrors"/>
		<on eventId="aggregationDoneWithErrors" newStateId="PROCESSED_WITH_ERRORS"/>
	</manual-state>

	<if id='areThereErrors' condition="errors.size() > 0" then="yes" else="no">
			<on eventId="yes" newStateId='PROCESSED_WITH_ERRORS'/>
			<on eventId="no" newStateId="PROCESSED"/>
	</if>
	<manual-state id="PROCESSED"/>
	<manual-state id="PROCESSED_WITH_ERRORS"/>
</flow>
</states>

